name: Sync DAG to Docker Container

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  sync_dag:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Verify file exists in dags directory
        run: |
          ls -l dags/
          ls -l dags/call_github_repository.py

      - name: Verify if containers are running
        run: |
          docker ps -a

      - name: Ensure /opt/airflow/dags/ exists in containers
        run: |
          docker exec airflow-webserver-container mkdir -p /opt/airflow/dags
          docker exec airflow-scheduler-container mkdir -p /opt/airflow/dags
          docker exec airflow-worker-container mkdir -p /opt/airflow/dags

      - name: Login to Docker Hub
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Copy DAG to Airflow Docker Containers
        run: |
          docker cp dags/call_github_repository.py airflow-webserver-container:/opt/airflow/dags/
          docker cp dags/call_github_repository.py airflow-scheduler-container:/opt/airflow/dags/
          docker cp dags/call_github_repository.py airflow-worker-container:/opt/airflow/dags/

      - name: Restart Airflow Containers
        run: |
          docker restart airflow-webserver-container
          docker restart airflow-scheduler-container
          docker restart airflow-worker-container
